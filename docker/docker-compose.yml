# =============================================================================
# Urocissa Docker Compose (Fix: Path Level Correction)
# =============================================================================

x-base-config: &base-config
  restart: unless-stopped

  # [修正 1] 環境變數設為當前目錄的 "上一層"
  # 這樣程式讀到的路徑就會是 /home/demo/Urocissa/docker/..
  # 雖然路徑裡帶有 ".."，但邏輯上它指向的就是專案根目錄
  environment:
    - UROCISSA_PATH=${PWD}/..

  ports:
    - "${UROCISSA_PORT:-5673}:${UROCISSA_PORT:-5673}"

  # [修正 2] 掛載點也全部改成 ${PWD}/..
  # 讓容器內的檔案結構與主機的 "上一層" 對齊
  volumes:
    # 核心設定檔
    - ../gallery-backend/config.json:${PWD}/../gallery-backend/config.json
    # 資料儲存
    - ../gallery-backend/db:${PWD}/../gallery-backend/db
    - ../gallery-backend/object:${PWD}/../gallery-backend/object

    # 範例: 如果有 syncPaths
    # - /home/demo/photos:/home/demo/photos

services:
  stable:
    <<: *base-config
    image: hsa00000/urocissa:latest
    container_name: urocissa-stable
    profiles: ["stable"]

  dev:
    <<: *base-config
    image: hsa00000/urocissa:dev
    container_name: urocissa-dev
    profiles: ["dev"]

  local:
    <<: *base-config
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        BUILD_TYPE: debug
    container_name: urocissa-local
    profiles: ["local"]
